document.addEventListener('DOMContentLoaded', () => {
    // ÂàùÂßãÂåñÊîπË£ùÂâçÂæåÂ∞çÊØîÊªëÂ°ä
    initializeComparisonSliders();
    
    // ÂàùÂßãÂåñÈ´òÁ¥öÊêúÂ∞ãÈù¢Êùø
    initializeAdvancedSearch();
    
    // ÂàùÂßãÂåñÂ±ïÁ§∫Âç°ÁâáÈªûÊìä‰∫ã‰ª∂
    initializeShowcaseCards();
    
    // ÂàùÂßãÂåñËºâÂÖ•Êõ¥Â§öÂäüËÉΩ
    initializeLoadMore();
    
    // ÂàùÂßãÂåñÁØ©ÈÅ∏ÂäüËÉΩ
    initializeFilters();
});

// ÊîπË£ùÂâçÂæåÂ∞çÊØîÊªëÂ°äÂäüËÉΩ
function initializeComparisonSliders() {
    document.querySelectorAll('.comparison-slider').forEach(slider => {
        const handle = slider.querySelector('.slider-handle');
        const afterImage = slider.querySelector('img:last-child');
        let isDragging = false;

        const moveSlider = (e) => {
            if (!isDragging) return;
            
            const rect = slider.getBoundingClientRect();
            const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
            const percentage = (x / rect.width) * 100;
            
            handle.style.left = `${percentage}%`;
            afterImage.style.clipPath = `polygon(${percentage}% 0, 100% 0, 100% 100%, ${percentage}% 100%)`;
        };

        handle.addEventListener('mousedown', () => isDragging = true);
        window.addEventListener('mousemove', moveSlider);
        window.addEventListener('mouseup', () => isDragging = false);
        
        // Ëß∏ÊéßÊîØÊè¥
        handle.addEventListener('touchstart', (e) => {
            isDragging = true;
            e.preventDefault();
        });
        
        window.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            const touch = e.touches[0];
            const rect = slider.getBoundingClientRect();
            const x = Math.max(0, Math.min(touch.clientX - rect.left, rect.width));
            const percentage = (x / rect.width) * 100;
            
            handle.style.left = `${percentage}%`;
            afterImage.style.clipPath = `polygon(${percentage}% 0, 100% 0, 100% 100%, ${percentage}% 100%)`;
        });
        
        window.addEventListener('touchend', () => isDragging = false);
    });
}

// È´òÁ¥öÊêúÂ∞ãÈù¢ÊùøÂäüËÉΩ
function initializeAdvancedSearch() {
    const advancedSearchBtn = document.querySelector('.advanced-search-btn');
    const advancedSearchPanel = document.querySelector('.advanced-search-panel');
    
    if (advancedSearchBtn && advancedSearchPanel) {
        advancedSearchBtn.addEventListener('click', () => {
            advancedSearchPanel.style.display = 
                advancedSearchPanel.style.display === 'none' ? 'block' : 'none';
            advancedSearchBtn.textContent = 
                advancedSearchPanel.style.display === 'none' ? 'È´òÁ¥öÊêúÂ∞ã' : 'Êî∂Ëµ∑È´òÁ¥öÊêúÂ∞ã';
        });
    }
}

// Â±ïÁ§∫Âç°ÁâáÈªûÊìä‰∫ã‰ª∂
function initializeShowcaseCards() {
    const modal = document.querySelector('.modal');
    const closeModal = document.querySelector('.close-modal');
    
    document.querySelectorAll('.showcase-card').forEach(card => {
        card.addEventListener('click', () => {
            const showcaseId = card.dataset.showcaseId;
            loadShowcaseDetails(showcaseId);
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
    });
    
    if (closeModal) {
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
    }
    
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });
}

// ËºâÂÖ•Â±ïÁ§∫Ë©≥Á¥∞Ë≥áË®ä
async function loadShowcaseDetails(showcaseId) {
    try {
        const response = await fetch(`/api/showcase/${showcaseId}`);
        const data = await response.json();
        
        updateModalContent(data);
        initializeGallery(data.images);
    } catch (error) {
        console.error('Error loading showcase details:', error);
    }
}

// Êõ¥Êñ∞Ê®°ÊÖãÊ°ÜÂÖßÂÆπ
function updateModalContent(data) {
    const modalContent = document.querySelector('.modal-content');
    
    // Êõ¥Êñ∞Â±ïÁ§∫Ë©≥Á¥∞Ë≥áË®ä
    // ÈÄôË£°ÈúÄË¶ÅÊ†πÊìöÂØ¶ÈöõAPIËøîÂõûÁöÑÊï∏ÊìöÁµêÊßãÈÄ≤Ë°åË™øÊï¥
    modalContent.querySelector('.showcase-title').textContent = data.title;
    modalContent.querySelector('.author-name').textContent = data.author;
    modalContent.querySelector('.project-description').textContent = data.description;
    
    // Êõ¥Êñ∞Èõ∂‰ª∂ÂàóË°®
    const partsList = modalContent.querySelector('.parts-list');
    partsList.innerHTML = data.parts.map(part => `
        <div class="part-item">
            <span>${part.name}</span>
            <span>${part.price}</span>
        </div>
    `).join('');
    
    // Êõ¥Êñ∞Ë¶èÊ†ºË≥áË®ä
    const specs = modalContent.querySelector('.specs');
    specs.innerHTML = Object.entries(data.specifications).map(([key, value]) => `
        <div class="spec-item">
            <label>${key}</label>
            <span>${value}</span>
        </div>
    `).join('');
}

// ÂàùÂßãÂåñÂúñÁâáÂ∫´
function initializeGallery(images) {
    const mainImage = document.querySelector('.main-image img');
    const thumbnailStrip = document.querySelector('.thumbnail-strip');
    const prevBtn = document.querySelector('.gallery-nav .prev');
    const nextBtn = document.querySelector('.gallery-nav .next');
    
    let currentImageIndex = 0;
    
    // Êõ¥Êñ∞Á∏ÆÂúñÂàóË°®
    thumbnailStrip.innerHTML = images.map((image, index) => `
        <img src="${image}" alt="Gallery thumbnail ${index + 1}"
             class="${index === 0 ? 'active' : ''}"
             onclick="changeMainImage(${index})">
    `).join('');
    
    // Êõ¥Êñ∞‰∏ªÂúñÁâá
    function updateMainImage() {
        mainImage.src = images[currentImageIndex];
        thumbnailStrip.querySelectorAll('img').forEach((thumb, index) => {
            thumb.classList.toggle('active', index === currentImageIndex);
        });
    }
    
    // ÂàáÊèõÂúñÁâá‰∫ã‰ª∂
    prevBtn.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateMainImage();
    });
    
    nextBtn.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateMainImage();
    });
    
    // Á∏ÆÂúñÈªûÊìä‰∫ã‰ª∂
    window.changeMainImage = (index) => {
        currentImageIndex = index;
        updateMainImage();
    };
}

// ËºâÂÖ•Êõ¥Â§öÂäüËÉΩ
function initializeLoadMore() {
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    let page = 1;
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/api/showcase?page=${++page}`);
                const data = await response.json();
                
                if (data.showcases.length > 0) {
                    appendShowcases(data.showcases);
                    initializeComparisonSliders();
                    initializeShowcaseCards();
                }
                
                if (data.isLastPage) {
                    loadMoreBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading more showcases:', error);
            }
        });
    }
}

// Ê∑ªÂä†Êñ∞ÁöÑÂ±ïÁ§∫Âç°Áâá
function appendShowcases(showcases) {
    const showcaseGrid = document.querySelector('.showcase-grid');
    
    showcases.forEach(showcase => {
        const card = document.createElement('div');
        card.className = 'showcase-card';
        card.dataset.showcaseId = showcase.id;
        
        card.innerHTML = `
            <div class="card-header">
                <div class="comparison-slider">
                    <img src="${showcase.beforeImage}" alt="Before modification">
                    <img src="${showcase.afterImage}" alt="After modification">
                    <div class="slider-handle"></div>
                </div>
            </div>
            <div class="card-body">
                <h3>${showcase.title}</h3>
                <div class="card-meta">
                    <span>${showcase.author}</span>
                    <span>${showcase.date}</span>
                </div>
                <p class="card-description">${showcase.description}</p>
                <div class="card-stats">
                    <span>üëç ${showcase.likes}</span>
                    <span>üí¨ ${showcase.comments}</span>
                    <span>‚≠ê ${showcase.rating}</span>
                </div>
            </div>
        `;
        
        showcaseGrid.appendChild(card);
    });
}

// ÂàùÂßãÂåñÁØ©ÈÅ∏ÂäüËÉΩ
function initializeFilters() {
    const filterForm = document.querySelector('.search-filters form');
    const searchInput = document.querySelector('.search-bar input');
    let filterTimeout;
    
    // ÊêúÂ∞ãËº∏ÂÖ•Èò≤Êäñ
    searchInput.addEventListener('input', () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            filterForm.dispatchEvent(new Event('submit'));
        }, 500);
    });
    
    // ÁØ©ÈÅ∏Ë°®ÂñÆÊèê‰∫§
    filterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(filterForm);
        const queryParams = new URLSearchParams(formData);
        
        try {
            const response = await fetch(`/api/showcase/filter?${queryParams}`);
            const data = await response.json();
            
            const showcaseGrid = document.querySelector('.showcase-grid');
            showcaseGrid.innerHTML = '';
            
            if (data.showcases.length > 0) {
                appendShowcases(data.showcases);
                initializeComparisonSliders();
                initializeShowcaseCards();
            } else {
                showcaseGrid.innerHTML = '<p class="no-results">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊîπË£ùÊ°à‰æã</p>';
            }
        } catch (error) {
            console.error('Error filtering showcases:', error);
        }
    });
    
    // Áõ£ËÅΩÁØ©ÈÅ∏Âô®ËÆäÊõ¥
    document.querySelectorAll('.filter-group select').forEach(select => {
        select.addEventListener('change', () => {
            filterForm.dispatchEvent(new Event('submit'));
        });
    });
}

// Â±ïÁ§∫Ê°à‰æãË≥áÊñô
const showcaseItems = [
    {
        id: 1,
        title: 'SYM DRG ÈÅãÂãïÊîπË£ù',
        image: 'images/bikes/drg.jpg',
        author: {
            name: 'Â∞èÂøó',
            avatar: 'images/avatars/user1.jpg'
        },
        category: 'scooter',
        style: 'street',
        model: 'SYM DRG',
        description: 'ÂçáÁ¥öLEDÂ§ßÁáà„ÄÅÈÅãÂãïÂûãÊéíÊ∞£ÁÆ°ËàáÊá∏ÂêäÔºåÊèêÂçáÊìçÊéßËàáÂ§ñËßÄ„ÄÇ',
        date: '2025-04-10',
        tags: ['LEDÂ§ßÁáà', 'ÊéíÊ∞£ÁÆ°', 'Êá∏Âêä', 'SYM'],
        stats: {
            likes: 120,
            comments: 8,
            views: 500
        }
    },
    {
        id: 2,
        title: 'SYM MMBCU Êó•Â∏∏ÈÄöÂã§ÊîπË£ù',
        image: 'images/bikes/mmbcu.jpg',
        author: {
            name: 'ÈòøÊòé',
            avatar: 'images/avatars/user2.jpg'
        },
        category: 'scooter',
        style: 'street',
        model: 'SYM MMBCU',
        description: 'ÊèõË£ùLEDÊñπÂêëÁáàËàáÈÅãÂãïÂûãÂæåÈÅøÈúáÔºåÂÖºÈ°ßÂÆâÂÖ®ËàáËàíÈÅ©„ÄÇ',
        date: '2025-04-09',
        tags: ['ÊñπÂêëÁáà', 'ÈÅøÈúá', 'SYM'],
        stats: {
            likes: 85,
            comments: 5,
            views: 320
        }
    },
    {
        id: 3,
        title: 'SYM SL Ë°óÈ†≠È¢®Ê†ºÊîπË£ù',
        image: 'images/bikes/sl.jpg',
        author: {
            name: 'Â∞èÁæé',
            avatar: 'images/avatars/user3.jpg'
        },
        category: 'scooter',
        style: 'street',
        model: 'SYM SL',
        description: 'Â§ñËßÄÂçáÁ¥öËàáÊéíÊ∞£ÁÆ°ÊîπË£ùÔºåÂ±ïÁèæÂÄã‰∫∫È¢®Ê†º„ÄÇ',
        date: '2025-04-08',
        tags: ['Â§ñËßÄ', 'ÊéíÊ∞£ÁÆ°', 'SYM'],
        stats: {
            likes: 60,
            comments: 3,
            views: 210
        }
    },
    {
        id: 4,
        title: 'SYM SR ÈÉΩÊúÉÈÄöÂã§ÊîπË£ù',
        image: 'images/bikes/sr.jpg',
        author: {
            name: 'ÈòøÂÆè',
            avatar: 'images/avatars/user4.jpg'
        },
        category: 'scooter',
        style: 'street',
        model: 'SYM SR',
        description: 'Âä†Ë£ùLEDÂ§ßÁáàËàáÈÅøÈúáÔºåÊèêÂçáÂ§úÈñìÂÆâÂÖ®ËàáËàíÈÅ©ÊÄß„ÄÇ',
        date: '2025-04-07',
        tags: ['LEDÂ§ßÁáà', 'ÈÅøÈúá', 'SYM'],
        stats: {
            likes: 45,
            comments: 2,
            views: 150
        }
    }
]; 