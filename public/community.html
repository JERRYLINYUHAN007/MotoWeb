<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社群討論 | 擎翔車業改裝專業網</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/community.css">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* 用戶菜單樣式 */
        .user-menu {
            position: relative;
            cursor: pointer;
        }
        
        .user-avatar {
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .user-avatar .username {
            color: white;
            font-weight: 500;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 180px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            z-index: 100;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .dropdown-menu a:hover {
            background-color: #f5f5f5;
        }
        
        .dropdown-menu i {
            width: 16px;
            margin-right: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <a href="index.html" aria-label="motoweb首頁">
                    <img src="MOTOWEB.png" alt="motoweb Logo" class="logo-img">
                    <h1>motoweb</h1>
                </a>
            </div>
            <div class="nav-links" id="navLinks">
                <div class="main-nav">
                    <a href="index.html">首頁</a>
                    <a href="products.html">改裝零件</a>
                    <a href="community.html" class="active" aria-current="page">社群討論</a>
                    <a href="gallery.html">作品展示</a>
                    <a href="events.html">改裝活動</a>
                </div>
                <div class="auth-buttons">
                    <a href="login.html" class="btn btn-secondary">登入</a>
                    <a href="register.html" class="btn btn-primary">註冊</a>
                </div>
                <div class="user-menu" style="display: none;">
                    <div class="user-avatar">
                        <img src="/images/default-avatar.svg" alt="用戶頭像" class="avatar">
                        <span class="username">用戶名稱</span>
                    </div>
                    <div class="dropdown-menu">
                        <a href="/profile.html"><i class="fas fa-user"></i> 個人資料</a>
                        <a href="/garage.html"><i class="fas fa-motorcycle"></i> 我的車庫</a>
                        <a href="/settings.html"><i class="fas fa-cog"></i> 帳號設定</a>
                        <a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> 登出</a>
                    </div>
                </div>
            </div>
            <button class="menu-toggle" aria-label="展開選單" aria-expanded="false" aria-controls="navLinks">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
        </div>
    </nav>

    <!-- 主要內容區域 -->
    <main class="main-container">
        <header class="page-header" style="background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('images/backgrounds/community-bg.jpg') center/cover no-repeat; padding: 4rem 5%; text-align: center; color: white;">
            <h1>社群討論</h1>
            <p>分享你的改裝經驗，與車友們一起交流討論</p>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="搜尋討論內容...">
                <button class="search-btn" id="search-btn"><i class="fas fa-search"></i></button>
        </div>
    </header>

        <main class="community-main-content">
            <div class="content-layout">
            <aside class="community-sidebar" id="community-sidebar">
                <h3>討論分類</h3>
                
                <div class="category-list">
                    <ul id="category-list">
                        <li><a href="#" data-category="all" class="active">所有分類 (載入中...)</a></li>
                        <li><a href="#" data-category="排氣系統">排氣系統 (載入中...)</a></li>
                        <li><a href="#" data-category="懸吊系統">懸吊系統 (載入中...)</a></li>
                        <li><a href="#" data-category="引擎改裝">引擎改裝 (載入中...)</a></li>
                        <li><a href="#" data-category="電子系統">電子系統 (載入中...)</a></li>
                        <li><a href="#" data-category="外觀套件">外觀套件 (載入中...)</a></li>
                        <li><a href="#" data-category="保養維護">保養維護 (載入中...)</a></li>
                    </ul>
            </div>

                <!-- 熱門標籤 -->
                <div class="popular-tags">
                    <h3>熱門標籤</h3>
                    <div class="tag-cloud" id="popular-tags">
                        <a href="#" class="tag" data-tag="排氣管">#排氣管</a>
                        <a href="#" class="tag" data-tag="避震器">#避震器</a>
                        <a href="#" class="tag" data-tag="動力提升">#動力提升</a>
                        <a href="#" class="tag" data-tag="LED">#LED</a>
                        <a href="#" class="tag" data-tag="保養">#保養</a>
                        <a href="#" class="tag" data-tag="新手">#新手</a>
            </div>
        </div>
        </aside>

            <section class="community-display-area">
                <div class="community-header">
                    <div class="results-count">
                        <span id="discussion-count">討論文章</span>
                    </div>
                    <div class="view-options">
                        <button class="btn-primary" id="new-post-btn">
                            <i class="fas fa-plus"></i> 發表文章
                        </button>
                    </div>
                </div>

                <!-- 載入指示器 -->
                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> 載入中...
                </div>

                <!-- 文章列表 -->
                <div class="discussion-list" id="discussions-grid">
                    <!-- 動態載入的討論文章 -->
                </div>

                <!-- 分頁控制 -->
                <div class="pagination" id="pagination">
                    <!-- 動態生成分頁按鈕 -->
                </div>
            </section>
        </main>
    </main>

    <!-- 發表文章模態框 -->
    <div id="post-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>發表新文章</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="post-form">
                    <div class="form-group">
                        <label for="post-title">標題 *</label>
                        <input type="text" id="post-title" required maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="post-category">分類 *</label>
                        <select id="post-category" required>
                            <option value="">請選擇分類</option>
                            <option value="排氣系統">排氣系統</option>
                            <option value="懸吊系統">懸吊系統</option>
                            <option value="引擎改裝">引擎改裝</option>
                            <option value="電子系統">電子系統</option>
                            <option value="外觀套件">外觀套件</option>
                            <option value="保養維護">保養維護</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="post-content">內容 *</label>
                        <textarea id="post-content" required rows="8" placeholder="分享你的改裝經驗、心得或問題..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>標籤 (最多5個)</label>
                        <div class="tag-input-container" id="tag-container">
                            <input type="text" id="tag-input" placeholder="輸入標籤後按 Enter">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-btn">取消</button>
                <button type="button" class="btn-primary" id="submit-btn">發表文章</button>
            </div>
        </div>
    </div>

    <!-- 頁腳 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>擎翔車業</h3>
                    <p>專業機車改裝，給你最棒的騎乘體驗</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>改裝服務</h4>
                    <ul>
                        <li><a href="products.html?category=power">動力系統</a></li>
                        <li><a href="products.html?category=exhaust">排氣系統</a></li>
                        <li><a href="products.html?category=suspension">懸吊系統</a></li>
                        <li><a href="products.html?category=appearance">外觀套件</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>客戶服務</h4>
                    <ul>
                        <li><a href="about.html">關於我們</a></li>
                        <li><a href="contact.html">聯絡我們</a></li>
                        <li><a href="warranty.html">保固說明</a></li>
                        <li><a href="faq.html">常見問題</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>聯絡資訊</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> 台中市西屯區工業區路123號</p>
                        <p><i class="fas fa-phone"></i> (04) 2359-8888</p>
                        <p><i class="fas fa-envelope"></i> info@cxmotor.com.tw</p>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 擎翔車業. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/common.js"></script>
    <script src="js/auth-state.js"></script>
    <script src="js/community-api.js"></script>
    <script>
        // 社群API實例
        const communityAPI = new CommunityAPI();
        
        // 全域變數
        let currentPage = 1;
        let currentCategory = 'all';
        let currentSearch = '';
        let isLoading = false;

        // DOM 元素
        const discussionsGrid = document.getElementById('discussions-grid');
        const loadingIndicator = document.getElementById('loading');
        const paginationContainer = document.getElementById('pagination');
        const categoryLinks = document.querySelectorAll('#category-list a');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const newPostBtn = document.getElementById('new-post-btn');
        const modal = document.getElementById('post-modal');
        const closeBtn = modal.querySelector('.close');
        const cancelBtn = document.getElementById('cancel-btn');
        const submitBtn = document.getElementById('submit-btn');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeFromURL();
            loadPosts();
            updateCategoryCounts();
            bindEvents();
        });

        // 從URL初始化頁面狀態
        function initializeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            currentPage = parseInt(urlParams.get('page')) || 1;
            currentCategory = urlParams.get('category') || 'all';
            currentSearch = urlParams.get('search') || '';
            
            // 更新分類選中狀態
            categoryLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.category === currentCategory) {
                    link.classList.add('active');
                }
            });
            
            // 更新搜尋框
            if (currentSearch) {
                searchInput.value = currentSearch;
            }
        }

        // 載入貼文
        async function loadPosts() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            try {
                const options = {
                    page: currentPage,
                    limit: 6
                };
                
                if (currentCategory !== 'all') {
                    options.category = currentCategory;
                }
                
                if (currentSearch) {
                    options.search = currentSearch;
                }
                
                const response = await communityAPI.getPosts(options);
                displayPosts(response.posts);
                updatePagination(response);
                
            } catch (error) {
                console.error('載入貼文失敗:', error);
                showError('載入貼文失敗，請稍後再試');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        // 顯示貼文
        function displayPosts(posts) {
            if (!posts || posts.length === 0) {
                discussionsGrid.innerHTML = '<div class="no-posts">沒有找到符合條件的文章</div>';
                return;
            }
            
            const postsHTML = posts.map(post => `
                <article class="discussion-item">
                    <div class="discussion-avatar">
                        <img src="${post.avatar || 'images/avatars/default-user.svg'}" alt="${post.author}">
                    </div>
                    <div class="discussion-content">
                        <h3 class="discussion-title">
                            <a href="discussion-detail.html?id=${post._id}">${post.title}</a>
                        </h3>
                        
                        <div class="discussion-meta">
                            <span class="discussion-author">by ${post.author}</span>
                            <span class="discussion-date">${formatDate(post.createdAt)}</span>
                            <span class="discussion-category">${post.category}</span>
                        </div>
                        
                        <p class="discussion-excerpt">${post.excerpt}</p>
                        
                        <div class="discussion-tags">
                            ${post.tags.map(tag => `<span class="discussion-tag" data-tag="${tag}">#${tag}</span>`).join('')}
                            </div>
                        
                            <div class="discussion-stats">
                            <span class="stats-item"><i class="fas fa-thumbs-up"></i> ${post.likes}</span>
                            <span class="stats-item"><i class="fas fa-eye"></i> ${post.views}</span>
                            <span class="stats-item"><i class="fas fa-comments"></i> ${post.commentCount}</span>
                        </div>
                    </div>
                </article>
            `).join('');
            
            discussionsGrid.innerHTML = postsHTML;
            
            // 綁定標籤點擊事件
            bindTagEvents();
        }

        // 更新分頁
        function updatePagination(response) {
            if (response.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // 上一頁
            if (currentPage > 1) {
                paginationHTML += `<a href="#" data-page="${currentPage - 1}">&laquo; 上一頁</a>`;
            }
            
            // 頁碼
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(response.totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<a href="#" data-page="1">1</a>`;
                if (startPage > 2) {
                    paginationHTML += '<span>...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<a href="#" data-page="${i}" ${i === currentPage ? 'class="active"' : ''}>${i}</a>`;
            }
            
            if (endPage < response.totalPages) {
                if (endPage < response.totalPages - 1) {
                    paginationHTML += '<span>...</span>';
                }
                paginationHTML += `<a href="#" data-page="${response.totalPages}">${response.totalPages}</a>`;
            }
            
            // 下一頁
            if (currentPage < response.totalPages) {
                paginationHTML += `<a href="#" data-page="${currentPage + 1}">下一頁 &raquo;</a>`;
            }
            
            paginationContainer.innerHTML = paginationHTML;
            
            // 綁定分頁點擊事件
            bindPaginationEvents();
        }

        // 更新分類計數
        async function updateCategoryCounts() {
            try {
                const stats = await communityAPI.getCategoryStats();
                
                categoryLinks.forEach(link => {
                    const category = link.dataset.category;
                    if (category === 'all') {
                        link.textContent = `所有分類 (${stats.all || 0})`;
                    } else if (stats[category] !== undefined) {
                        link.textContent = `${category} (${stats[category]})`;
                    } else {
                        link.textContent = `${category} (0)`;
                    }
                });
            } catch (error) {
                console.error('更新分類計數失敗:', error);
            }
        }

        // 綁定事件
        function bindEvents() {
            // 分類點擊
            categoryLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 更新選中狀態
                    categoryLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // 更新頁面狀態
                    currentCategory = link.dataset.category;
                    currentPage = 1;
                    currentSearch = '';
                    searchInput.value = '';
                    
                    updateURL();
                    loadPosts();
                });
            });
            
            // 搜尋
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // 模態框
            newPostBtn.addEventListener('click', openModal);
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            submitBtn.addEventListener('click', handleSubmitPost);
            
            // 點擊模態框外部關閉
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // 綁定標籤事件
        function bindTagEvents() {
            const tagElements = document.querySelectorAll('.discussion-tag[data-tag], .tag[data-tag]');
            tagElements.forEach(tag => {
                tag.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tagValue = tag.dataset.tag;
                    
                    // 如果有搜尋輸入框，使用它
                    if (searchInput) {
                        searchInput.value = tagValue;
                        performSearch();
                    } else {
                        // 否則直接搜尋標籤
                        currentSearch = tagValue;
                        currentPage = 1;
                        currentCategory = 'all';
                        updateURL();
                        loadPosts();
                    }
                });
            });
        }

        // 綁定分頁事件
        function bindPaginationEvents() {
            const pageLinks = paginationContainer.querySelectorAll('a[data-page]');
            pageLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = parseInt(link.dataset.page);
                    updateURL();
                    loadPosts();
                    window.scrollTo(0, 0);
                });
            });
        }

        // 執行搜尋
        function performSearch() {
            currentSearch = searchInput.value.trim();
            currentPage = 1;
            currentCategory = 'all';
            
            // 更新分類選中狀態
            categoryLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.category === 'all') {
                    link.classList.add('active');
                }
            });
            
            updateURL();
            loadPosts();
        }

        // 開啟模態框
        function openModal() {
            // 檢查登入狀態
            const token = localStorage.getItem('token');
            if (!token) {
                alert('請先登入才能發表文章');
                // 可以導向登入頁面
                window.location.href = 'login.html';
                return;
            }
            
            modal.style.display = 'block';
            initTagInput();
        }

        // 關閉模態框
        function closeModal() {
            modal.style.display = 'none';
            clearForm();
        }

        // 清空表單
        function clearForm() {
            document.getElementById('post-title').value = '';
            document.getElementById('post-category').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('tag-input').value = '';
            
            // 清空標籤
            const tagItems = document.querySelectorAll('.tag-item');
            tagItems.forEach(item => item.remove());
        }

        // 處理發表文章
        async function handleSubmitPost() {
            const title = document.getElementById('post-title').value.trim();
                const category = document.getElementById('post-category').value;
            const content = document.getElementById('post-content').value.trim();
                
                if (!title || !category || !content) {
                    alert('請填寫所有必填欄位');
                    return;
                }
                
                // 收集標籤
                const tagItems = document.querySelectorAll('.tag-item');
                const tags = Array.from(tagItems).map(item => item.dataset.tagValue);
                
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '發表中...';
                
                await communityAPI.createPost({
                    title,
                    category,
                    content,
                    tags
                });
                
                alert('文章發表成功！');
                closeModal();
                
                // 重新載入貼文列表
                currentPage = 1;
                loadPosts();
                updateCategoryCounts();
                
            } catch (error) {
                console.error('發表文章失敗:', error);
                alert('發表文章失敗：' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '發表文章';
            }
        }
        
        // 標籤輸入功能
        function initTagInput() {
            const tagInput = document.getElementById('tag-input');
            const tagContainer = document.getElementById('tag-container');
            
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    const tagValue = tagInput.value.trim();
                    if (!tagValue) return;
                    
                    // 檢查是否已存在相同標籤
                    const existingTags = Array.from(tagContainer.querySelectorAll('.tag-item'))
                        .map(tag => tag.dataset.tagValue);
                    
                    if (existingTags.includes(tagValue)) {
                        tagInput.value = '';
                        return;
                    }
                    
                    // 限制最多5個標籤
                    if (existingTags.length >= 5) {
                        alert('最多只能添加5個標籤');
                        return;
                    }
                    
                    // 創建標籤元素
                    const tagItem = document.createElement('div');
                    tagItem.className = 'tag-item';
                    tagItem.dataset.tagValue = tagValue;
                    tagItem.innerHTML = `
                        ${tagValue}
                        <span class="tag-remove">&times;</span>
                    `;
                    
                    // 點擊刪除標籤
                    const removeBtn = tagItem.querySelector('.tag-remove');
                    removeBtn.addEventListener('click', () => {
                        tagItem.remove();
                    });
                    
                    // 插入標籤元素
                    tagContainer.insertBefore(tagItem, tagInput);
                    tagInput.value = '';
                }
            });
        }
        
        // 更新URL
        function updateURL() {
            const params = new URLSearchParams();
            
            if (currentPage > 1) {
                params.append('page', currentPage);
            }
            
            if (currentCategory !== 'all') {
                params.append('category', currentCategory);
            }
            
            if (currentSearch) {
                params.append('search', currentSearch);
            }
            
            const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.pushState(null, '', newURL);
        }

        // 顯示載入狀態
        function showLoading() {
            loadingIndicator.style.display = 'block';
            discussionsGrid.style.opacity = '0.5';
        }

        // 隱藏載入狀態
        function hideLoading() {
            loadingIndicator.style.display = 'none';
            discussionsGrid.style.opacity = '1';
        }

        // 顯示錯誤訊息
        function showError(message) {
            discussionsGrid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return '1天前';
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return `${weeks}週前`;
            } else {
                return date.toLocaleDateString('zh-TW');
            }
        }
    </script>
</body>
</html>